name: C++ CI
on:
  push:
    branches:
      - master
      - development
      - '@feat/*'
  pull_request:
    branches:
      - master
      - development
      - '@feat/*'
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # Install build + lint dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ clang-tidy

      # Step 1: Lint with clang-tidy
      - name: Run clang-tidy
        run: |
            cmake -S . -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
            clang-tidy -p build $(find . -name '*.cpp') --warnings-as-errors=*

      # Step 2: Build with AddressSanitizer enabled
      - name: Configure (ASan)
        run: cmake -S . -B build-asan -DCMAKE_CXX_FLAGS="-fsanitize=address -g -O1"

      - name: Build (ASan)
        run: cmake --build build-asan

      # Step 3: Run memory-leak tests (ASan will fail on leak)
      - name: Run with ASan
        run: |
          export ASAN_OPTIONS=detect_leaks=1
          ctest --test-dir build-asan --output-on-failure
